# ============================================================================
# THIS FILE IS GENERATED - DO NOT EDIT DIRECTLY
# ============================================================================
# To modify this workflow, edit scripts/generate-workflows.js and run:
#   npm run generate-workflows
# ============================================================================

name: ğŸ“ Submit New Project Guide

on:
  issues:
    types: [opened, labeled]

jobs:
  create-pr:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'project-submission')

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse issue body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;

            // Parse the issue form fields
            const categoryMatch = body.match(/### Category ğŸ—ƒï¸\s*\n\n(.+?)(?=\n\n###|\n*$)/s);
            const projectNameMatch = body.match(/### File Name ğŸ’¾\s*\n\n(.+?)(?=\n\n###|\n*$)/s);
            const contentMatch = body.match(/### Project Markdown ğŸ“\s*\n\n([\s\S]+?)$/);

            if (!categoryMatch || !projectNameMatch || !contentMatch) {
              core.setFailed('Could not parse issue body. Please ensure all fields are filled out.');
              return;
            }

            const category = categoryMatch[1].trim();
            const projectName = projectNameMatch[1].trim();
            const markdownContent = contentMatch[1].trim();

            // Validate category
            const validCategories = ["Educational","Games","Getting Started"];
            if (!validCategories.includes(category)) {
              core.setFailed(`Invalid category: ${category}. Must be one of: ${validCategories.join(', ')}`);
              return;
            }

            // Sanitize filename
            const filename = projectName
              .toLowerCase()
              .replace(/[^a-z0-9-]/g, '-')
              .replace(/-+/g, '-')
              .replace(/^-|-$/g, '');

            core.setOutput('category', category);
            core.setOutput('project_name', projectName);
            core.setOutput('filename', filename);
            core.setOutput('filepath', `projects/${category}/${filename}.md`);

            // Write content to a file for the next step
            const fs = require('fs');
            fs.writeFileSync('markdown_content.tmp', markdownContent);

      - name: Create new branch
        run: |
          BRANCH_NAME="project-submission-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create project file
        run: |
          FILEPATH="${{ steps.parse.outputs.filepath }}"

          # Create directory if it doesn't exist
          mkdir -p "$(dirname "$FILEPATH")"

          # Move the temp content file to the final location
          mv markdown_content.tmp "$FILEPATH"

      # ========================================================================
      # Integration steps - these replicate the PR Integration Workflow
      # This is necessary because the integration workflow cannot automatically
      # run on PRs created by this workflow due to GitHub security restrictions
      # ========================================================================

      - name: ğŸƒ Run actions/setup-node@v4
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
      - name: ğŸªœ Install dependencies
        run: npm ci
      - name: ğŸ§‘â€âš–ï¸ Generate license file
        run: npm run licenses
      - name: ğŸ“½ï¸ Generate project files
        run: npm run generate-projects
      - name: ğŸ“ Format project
        run: npm run format

      - name: ğŸ’¾ Commit all changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Add new project: ${{ steps.parse.outputs.project_name }}"
          git push origin "$BRANCH_NAME"

      - name: ğŸ” Lint project
        run: npm run lint
      - name: âœ… Svelte check
        run: npm run check
      - name: ğŸ—ï¸ Build project
        run: npm run build
      - name: ğŸ­ Set up playwright
        run: npx playwright install
      - name: ğŸ§ª Run tests
        run: npm test

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr create \
            --title "New Project Submission: ${{ steps.parse.outputs.project_name }}" \
            --body "**Category ğŸ—ƒï¸:** ${{ steps.parse.outputs.category }}
          **Submitted by:** @${{ github.event.issue.user.login }}
          **Issue:** #${{ github.event.issue.number }}

          This PR adds a new project to the site. Please review the content for quality and appropriateness before merging.

          Closes #${{ github.event.issue.number }}" \
            --base main \
            --head "$BRANCH_NAME"

          FYI: @matthewnoel
