name: ðŸ“ Submit New Project Guide

on:
  issues:
    types: [opened, labeled]

jobs:
  create-pr:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'project-submission')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse issue body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;

            // Parse the issue form fields
            const categoryMatch = body.match(/### Category\s*\n\n(.+?)(?=\n\n###|\n*$)/s);
            const projectNameMatch = body.match(/### Project Name\s*\n\n(.+?)(?=\n\n###|\n*$)/s);
            const contentMatch = body.match(/### Project Guide Content\s*\n\n([\s\S]+?)$/);

            if (!categoryMatch || !projectNameMatch || !contentMatch) {
              core.setFailed('Could not parse issue body. Please ensure all fields are filled out.');
              return;
            }

            const category = categoryMatch[1].trim();
            const projectName = projectNameMatch[1].trim();
            const markdownContent = contentMatch[1].trim();

            // Validate category
            const validCategories = ['Getting Started', 'Educational', 'Games'];
            if (!validCategories.includes(category)) {
              core.setFailed(`Invalid category: ${category}. Must be one of: ${validCategories.join(', ')}`);
              return;
            }

            // Sanitize filename
            const filename = projectName
              .toLowerCase()
              .replace(/[^a-z0-9-]/g, '-')
              .replace(/-+/g, '-')
              .replace(/^-|-$/g, '');

            core.setOutput('category', category);
            core.setOutput('project_name', projectName);
            core.setOutput('filename', filename);
            core.setOutput('filepath', `projects/${category}/${filename}.md`);

            // Write content to a file for the next step
            const fs = require('fs');
            fs.writeFileSync('markdown_content.tmp', markdownContent);

      - name: Create new branch
        run: |
          BRANCH_NAME="project-submission-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create project file
        run: |
          FILEPATH="${{ steps.parse.outputs.filepath }}"

          # Create directory if it doesn't exist
          mkdir -p "$(dirname "$FILEPATH")"

          # Move the temp content file to the final location
          mv markdown_content.tmp "$FILEPATH"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Add new project: ${{ steps.parse.outputs.project_name }}"
          git push origin "$BRANCH_NAME"

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr create \
            --title "New Project Submission: ${{ steps.parse.outputs.project_name }}" \
            --body "**Category:** ${{ steps.parse.outputs.category }}
          **Submitted by:** @${{ github.event.issue.user.login }}
          **Issue:** #${{ github.event.issue.number }}

          This PR adds a new project to the site. Please review the content for quality and appropriateness before merging.

          Closes #${{ github.event.issue.number }}" \
            --base main \
            --head "$BRANCH_NAME"
